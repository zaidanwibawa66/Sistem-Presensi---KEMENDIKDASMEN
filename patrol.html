<!doctype html>
<html lang="id">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no">
    <title>Lapor Patroli - E-Presensi</title>
    <link rel="icon" type="image/png" href="assets/images/logo.png">
    
    <link href="assets/bootstrap/bootstrap-5.0.2-dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="assets/css/style.css">

    <style>
        /* CSS Khusus Halaman Patroli */
        .patrol-header {
            margin-bottom: 20px;
            text-align: center;
        }
        .camera-frame {
            position: relative;
            width: 100%;
            border-radius: 20px;
            overflow: hidden;
            background: #000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            aspect-ratio: 3/4; 
        }
        #camera-preview, #photo-result {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .camera-overlay {
            position: absolute;
            bottom: 20px;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: center;
            z-index: 10;
        }
        .btn-shutter {
            width: 60px;
            height: 60px;
            background: white;
            border: 4px solid rgba(255,255,255,0.5);
            border-radius: 50%;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            transition: transform 0.2s;
        }
        .btn-shutter:active { transform: scale(0.9); }
        .hidden { display: none !important; }

        /* --- STYLE TOMBOL KIRIM UTAMA --- */
        #btn-send {
            transition: all 0.3s ease;
            font-size: 1rem;
            letter-spacing: 0.5px;
            
            /* Bentuk Konsisten */
            border-radius: 12px !important; 
            
            /* Padding & Height Reset */
            padding-top: 14px !important;
            padding-bottom: 14px !important;
            height: auto !important;       /* Mencegah tombol memanjang */
            min-height: auto !important;   /* Reset jika ada min-height */
            
            /* Flexbox */
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* --- FIX KHUSUS LAYAR KECIL (<= 380px) --- */
        @media (max-width: 380px) {
            #btn-send {
                font-size: 0.9rem; 
                padding: 12px !important;
                
                /* KUNCI PERBAIKAN: */
                aspect-ratio: auto !important; /* Matikan rasio kotak 1:1 */
                width: 100% !important;        /* Paksa lebar penuh */
            }
            
            /* Opsional: Pastikan teks di dalam tombol tetap muncul */
            #btn-send span {
                display: inline-block !important;
            }
        }
    </style>
  </head>
  <body>

    <nav class="desktop-navbar desktop-view">
        <div class="nav-container">
            <div class="d-flex align-items-center gap-3">
                <img src="assets/images/logo.png" alt="Logo" style="width: 45px;">
                <span class="fw-bold text-primary fs-5 brand-text-bold">E-Presensi</span>
            </div>

            <div class="nav-links d-flex gap-4 brand-text-bold">
                <a href="home.html" class="nav-link-desk active">Home</a>
                <a href="presensi.html" class="nav-link-desk">Presensi</a>
                <a href="calendar.html" class="nav-link-desk">Kalender</a>
                <a href="profile.html" class="nav-link-desk">Profil</a>
            </div>

            <div class="d-flex align-items-center gap-3">
                
                <button id="btnActionDesktop" onclick="processAttendance()" class="btn btn-primary rounded-pill px-4 fw-bold shadow-sm btn-gradient d-flex align-items-center gap-2">
                    <i class="fas fa-fingerprint"></i> 
                    <span>Absen Sekarang</span>
                </button>

                <div class="position-relative cursor-pointer mx-3" onclick="handleNotificationClick()">
                    <i class="far fa-bell fa-lg text-secondary"></i>
                    <span id="notifBadge" class="position-absolute top-0 start-100 translate-middle p-1 bg-danger border border-light rounded-circle d-none"></span>
                </div>

                <div class="position-relative">
                    <div class="avatar-circle bg-primary text-white d-flex align-items-center justify-content-center shadow-sm fw-bold cursor-pointer" onclick="toggleProfileDropdown(event)">
                        <span class="user-initials">ME</span>
                        <span class="position-absolute bottom-0 end-0 bg-success border border-white rounded-circle" style="width: 10px; height: 10px;"></span>
                    </div>

                    <div id="profileDropdown" class="dropdown-menu-custom shadow-lg rounded-4 d-none animate-fade-in-fast">
                        <div class="p-3 border-bottom">
                            <div class="d-flex align-items-center gap-3">
                                <div class="avatar-circle bg-primary text-white d-flex align-items-center justify-content-center fw-bold flex-shrink-0" style="width: 45px; height: 45px; font-size: 1.1rem;">
                                    <span class="user-initials">ME</span>
                                </div>
                                <div class="overflow-hidden">
                                    <h6 class="mb-0 fw-bold text-dark text-truncate user-fullname-text" style="max-width: 180px;">Nama User</h6>
                                    <small class="text-muted d-block" style="font-size: 0.75rem;">Alih Daya</small>
                                </div>
                            </div>
                        </div>
                        <div class="p-2">
                            <a href="#" onclick="handleLogout()" class="d-flex align-items-center gap-2 px-3 py-2 rounded-3 text-decoration-none text-danger hover-bg-red-soft">
                                <i class="fas fa-power-off" style="width: 20px;"></i>
                                <span class="small fw-bold">Keluar</span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <main class="main-content">
        <div class="container content-container animate-fade-in">
            
            <div class="d-flex align-items-center mb-4 pt-4 mobile-view">
                <a href="home.html" class="btn btn-light rounded-circle shadow-sm text-primary" style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-arrow-left"></i>
                </a>
                <h5 class="fw-bold m-0 ms-3 text-dark">Lapor Patroli</h5>
            </div>

            <div class="row justify-content-center">
                <div class="col-md-6 col-lg-5">
                    
                    <div class="card border-0 shadow-sm rounded-4 bg-white p-3 mb-4">
                        
                        <div class="camera-frame mb-3 position-relative">
                            <video id="camera-preview" autoplay playsinline></video>
                            <canvas id="canvas" class="hidden"></canvas>
                            <img id="photo-result" class="hidden animate-fade-in">
                            
                            <div class="camera-overlay" id="shutter-container">
                                <button id="btn-capture" class="btn-shutter" title="Ambil Foto">
                                    <i class="fas fa-camera text-secondary" style="font-size: 1.2rem;"></i>
                                </button>
                            </div>
                        </div>

                        <button id="btn-retake" class="btn btn-outline-secondary rounded-pill w-100 mb-3 fw-bold hidden">
                            <i class="fas fa-redo me-2"></i> Foto Ulang
                        </button>

                        <div class="form-group mb-3">
                            <label class="fw-bold small text-muted mb-2">Catatan Kondisi (Opsional)</label>
                            <textarea id="note" class="form-control custom-input" rows="3" placeholder="Contoh: Gerbang depan aman, lampu menyala..."></textarea>
                        </div>
                        
                        <div id="location-info" class="alert alert-light border d-flex align-items-center gap-2 mb-4" style="border-radius: 12px; font-size: 0.85rem;">
                            <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                            <span class="text-muted">Mencari titik lokasi GPS...</span>
                        </div>

                        <button id="btn-send" class="btn btn-warning w-100 fw-bold shadow-sm text-white" disabled style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); border:none;">
                            <i class="fas fa-paper-plane me-2"></i> KIRIM LAPORAN
                        </button>
                    </div>

                </div>
            </div>

        </div>
    </main>

    <div id="appModal" class="custom-modal-overlay d-none">
        <div class="custom-modal-box text-center">
            <div class="modal-icon-wrapper" id="modalIconBg"><i class="fas fa-check" id="modalIcon"></i></div>
            <h5 id="modalTitle" class="fw-bold mt-3">Info</h5>
            <p id="modalMessage" class="text-muted small mb-4">...</p>
            <button onclick="closeAppModal()" class="btn btn-primary w-100 rounded-pill">Oke</button>
        </div>
    </div>

    <script src="assets/js/login.js"></script>
    <script src="assets/js/presensi.js"></script>
    <script src="assets/js/calendar.js"></script>
    <script src="assets/js/profile.js"></script> 
    <script src="assets/js/patrol.js"></script> 
    <script src="assets/js/script.js"></script> 
  </body>
</html>